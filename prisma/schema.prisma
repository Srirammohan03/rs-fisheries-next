generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  finance
  clerk
  documentation
  sales
  partner
  seniorExecutive
  juniorExecutive
  executive
  supervisor
  others
}

model User {
  id       String @id @default(cuid())
  password String

  employeeId String   @unique
  employee   Employee @relation(fields: [employeeId], references: [id])

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  salaries         Salaries[]
  employeePayments EmployeePayment[]
  packingAmounts   PackingAmount[]
  dispatchCharges  DispatchCharge[]
}

model FishVariety {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
}

model FormerLoading {
  id         String   @id @default(uuid())
  fishCode   String
  billNo     String   @unique
  FarmerName String?
  village    String
  date       DateTime

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleNo String?

  totalTrays    Int   @default(0)
  totalLooseKgs Float @default(0)
  totalTrayKgs  Float @default(0)
  totalKgs      Float @default(0)
  totalPrice    Float @default(0)

  dispatchChargesTotal Float @default(0)
  packingAmountTotal   Float @default(0)
  grandTotal           Float @default(0)

  items           FormerItem[]
  dispatchCharges DispatchCharge[] @relation("FormerDispatchCharges")
  packingAmounts  PackingAmount[]  @relation("FormerPackingAmounts")

  createdAt DateTime @default(now())
}

model FormerItem {
  id              String @id @default(uuid())
  formerLoadingId String
  varietyCode     String
  noTrays         Int
  trayKgs         Float
  loose           Float
  totalKgs        Float
  pricePerKg      Float  @default(0)
  totalPrice      Float  @default(0)

  loading FormerLoading @relation(fields: [formerLoadingId], references: [id], onDelete: Cascade)

  @@index([formerLoadingId])
}

model AgentLoading {
  id        String   @id @default(uuid())
  fishCode  String
  agentName String
  billNo    String   @unique
  village   String
  date      DateTime

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleNo String?

  totalTrays    Int   @default(0)
  totalLooseKgs Float @default(0)
  totalTrayKgs  Float @default(0)
  totalKgs      Float @default(0)
  totalPrice    Float @default(0)

  dispatchChargesTotal Float @default(0)
  packingAmountTotal   Float @default(0)
  grandTotal           Float @default(0)

  items           AgentItem[]
  dispatchCharges DispatchCharge[] @relation("AgentDispatchCharges")
  packingAmounts  PackingAmount[]  @relation("AgentPackingAmounts")

  createdAt DateTime @default(now())
}

model AgentItem {
  id             String @id @default(uuid())
  agentLoadingId String
  varietyCode    String
  noTrays        Int
  trayKgs        Float
  loose          Float
  totalKgs       Float
  pricePerKg     Float  @default(0)
  totalPrice     Float  @default(0)

  loading AgentLoading @relation(fields: [agentLoadingId], references: [id], onDelete: Cascade)

  @@index([agentLoadingId])
}

model ClientLoading {
  id         String   @id @default(uuid())
  clientName String
  billNo     String   @unique
  date       DateTime

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleNo String?

  fishCode      String
  village       String
  totalTrays    Int    @default(0)
  totalLooseKgs Float  @default(0)
  totalTrayKgs  Float  @default(0)
  totalKgs      Float  @default(0)
  totalPrice    Float  @default(0)

  dispatchChargesTotal Float @default(0)
  packingAmountTotal   Float @default(0)
  grandTotal           Float @default(0)

  accountNumber String?
  ifsc          String?
  bankName      String?
  bankAddress   String?

  items           ClientItem[]
  clientPayments  ClientPayment[]
  dispatchCharges DispatchCharge[] @relation("ClientDispatchCharges")
  packingAmounts  PackingAmount[]  @relation("ClientPackingAmounts")

  createdAt DateTime @default(now())
}

model ClientItem {
  id              String @id @default(uuid())
  clientLoadingId String
  varietyCode     String
  noTrays         Int
  trayKgs         Float
  loose           Float
  totalKgs        Float
  pricePerKg      Float  @default(0)
  totalPrice      Float  @default(0)

  loading ClientLoading @relation(fields: [clientLoadingId], references: [id], onDelete: Cascade)

  @@index([clientLoadingId])
}

model Salaries {
  id        String   @id @default(cuid())
  userId    String
  month     DateTime
  amount    Int
  notes     String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model VendorPayment {
  id                String          @id @default(uuid())
  vendorId          String
  vendorKey         String
  vendorName        String
  source            String
  date              DateTime
  amount            Float
  paymentMode       String
  accountNumber     String?
  ifsc              String?
  bankName          String?
  bankAddress       String?
  paymentdetails    String?
  paymentRef        String?
  isInstallment     Boolean         @default(false)
  installments      Int?
  installmentNumber Int?
  createdAt         DateTime        @default(now())
  referenceNo       String?
  vendorInvoice     VendorInvoice[]

  @@index([vendorId])
  @@index([vendorKey])
  @@index([source])
}

model ClientPayment {
  id                String   @id @default(uuid())
  clientId          String
  clientKey         String
  clientName        String
  date              DateTime
  amount            Float
  paymentMode       String
  referenceNo       String?
  paymentRef        String?
  accountNumber     String?
  ifsc              String?
  bankName          String?
  bankAddress       String?
  paymentdetails    String?
  isInstallment     Boolean  @default(false)
  installments      Int?
  installmentNumber Int?
  createdAt         DateTime @default(now())

  client ClientLoading @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientKey])
  @@index([date])
}

enum VehicleOwnership {
  OWN
  RENT
}

enum FuelType {
  DIESEL
  PETROL
  CNG
  ELECTRIC
}

enum VehicleType {
  OWN
  RENT
}

enum PaymentMode {
  AC
  UPI
  CASH
  CHEQUE
}

model VehicleEntry {
  id           String       @id @default(cuid())
  vehicleId    String
  vehicle      Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  type         VehicleType
  trip         String
  date         DateTime
  diesel       Float?       @default(0)
  service      Float?       @default(0)
  fastag       Float?       @default(0)
  eChallan     Float?       @default(0)
  tyres        Float?       @default(0)
  rentAmount   Float?
  paymentMode  PaymentMode?
  totalExpense Float        @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([vehicleId])
}

model Vehicle {
  id                String           @id @default(cuid())
  vehicleNumber     String           @unique
  ownership         VehicleOwnership
  manufacturer      String?
  model             String?
  yearOfManufacture Int?
  fuelType          FuelType?
  engineNumber      String?          @unique
  chassisNumber     String?          @unique
  capacityInTons    Float?
  bodyType          String?
  rcValidity        DateTime?
  insuranceExpiry   DateTime?
  fitnessExpiry     DateTime?
  pollutionExpiry   DateTime?
  permitExpiry      DateTime?
  roadTaxExpiry     DateTime?
  assignedDriverId  String?          @unique
  assignedDriver    Driver?          @relation(fields: [assignedDriverId], references: [id])
  rentalAgency      String?
  rentalRatePerDay  Float?
  isActive          Boolean          @default(true)
  remarks           String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  farmerLoadings FormerLoading[]
  agentLoadings  AgentLoading[]
  clientLoadings ClientLoading[]
  trips          VehicleEntry[]
}

model Driver {
  id            String @id @default(cuid())
  name          String
  phone         String @unique
  licenseNumber String @unique
  address       String
  age           Int
  aadharNumber  String @unique

  aadharProof  String?
  licenseProof String?

  createdAt DateTime @default(now())

  assignedVehicle Vehicle?
}

model EmployeePayment {
  id           String      @id @default(uuid())
  userId       String
  employeeName String
  date         DateTime
  amount       Float
  paymentMode  PaymentMode
  reference    String?
  createdAt    DateTime    @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
}

model PackingAmount {
  id             String              @id @default(uuid())
  billNo         String              @unique
  mode           String
  sourceType     DispatchSourceType? // For filtering/querying
  sourceRecordId String? // Legacy field (optional)

  workers     Int
  temperature Float
  totalAmount Float
  paymentMode PaymentMode @default(CASH)
  reference   String?
  createdAt   DateTime    @default(now())
  createdById String?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // NEW: Separate foreign key fields
  formerLoadingId String?
  agentLoadingId  String?
  clientLoadingId String?

  // Clean relations using dedicated FKs
  formerLoading FormerLoading? @relation("FormerPackingAmounts", fields: [formerLoadingId], references: [id], onDelete: SetNull)
  agentLoading  AgentLoading?  @relation("AgentPackingAmounts", fields: [agentLoadingId], references: [id], onDelete: SetNull)
  clientLoading ClientLoading? @relation("ClientPackingAmounts", fields: [clientLoadingId], references: [id], onDelete: SetNull)

  @@index([sourceType, sourceRecordId])
  @@index([createdAt])
  @@index([formerLoadingId])
  @@index([agentLoadingId])
  @@index([clientLoadingId])
}

model InvoiceCounter {
  id           Int  @id @default(1)
  count        Int  @default(0)
  packingCount Int  @default(0)
  packingYear  Int?
  invoiceCount Int  @default(0)
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  seq           Int
  prefix        String   @default("RS-Fisheries-")
  partyName     String?
  partyAddress  String?
  date          DateTime @default(now())
  items         Json
  subtotal      Float
  taxAmount     Float
  total         Float
  gstPercent    Float    @default(0)
  hsnCode       String?
  billTo        String?
  shipTo        String?
  pan           String?
  bankDetails   String?
  taxInWords    String?
  createdAt     DateTime @default(now())
}

model VendorInvoice {
  id             String   @id @default(uuid())
  paymentId      String   @unique
  vendorId       String
  vendorName     String
  source         String
  sourceRecordId String?
  invoiceNo      String   @unique
  invoiceDate    DateTime
  hsn            String
  gstPercent     Float
  taxableValue   Float
  gstAmount      Float
  totalAmount    Float
  billTo         String
  shipTo         String
  description    String?
  isFinalized    Boolean  @default(false)
  createdAt      DateTime @default(now())

  payment VendorPayment @relation(fields: [paymentId], references: [id])
}

enum DispatchSourceType {
  FORMER
  AGENT
  CLIENT
}

enum DispatchChargeType {
  ICE_COOLING
  TRANSPORT
  OTHER
  PACKING
}

model DispatchCharge {
  id             String              @id @default(uuid())
  sourceType     DispatchSourceType? // For filtering/querying (optional but useful)
  sourceRecordId String? // Legacy — keep for backward compatibility if needed

  type        DispatchChargeType
  label       String?
  amount      Float              @default(0)
  notes       String?
  createdAt   DateTime           @default(now())
  createdById String?
  createdBy   User?              @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // NEW: Separate foreign key fields — no conflict!
  formerLoadingId String?
  agentLoadingId  String?
  clientLoadingId String?

  // Relations using dedicated FK fields
  formerLoading FormerLoading? @relation("FormerDispatchCharges", fields: [formerLoadingId], references: [id], onDelete: SetNull)
  agentLoading  AgentLoading?  @relation("AgentDispatchCharges", fields: [agentLoadingId], references: [id], onDelete: SetNull)
  clientLoading ClientLoading? @relation("ClientDispatchCharges", fields: [clientLoadingId], references: [id], onDelete: SetNull)

  @@index([sourceType, sourceRecordId])
  @@index([type])
  @@index([formerLoadingId])
  @@index([agentLoadingId])
  @@index([clientLoadingId])
}

enum Gender {
  Male
  Female
  Other
}

enum MaritalStatus {
  Single
  Married
}

model Employee {
  id String @id @default(uuid())

  // Office Information
  employeeId          String   @unique
  doj                 DateTime
  department          String
  designation         String
  basicSalary         Int
  hra                 Int?
  conveyanceAllowance Int?
  specialAllowance    Int?
  grossSalary         Int
  ctc                 Int
  workLocation        String?
  shiftType           String?

  // Personal Information
  fullName         String
  fatherName       String
  dob              DateTime
  gender           Gender
  aadhaar          String         @unique
  pan              String         @unique
  mobile           String         @unique
  altMobile        String?
  email            String?        @unique
  currentAddress   String
  permanentAddress String
  maritalStatus    MaritalStatus?
  nationality      String?

  // Bank Details
  bankName      String
  branchName    String
  accountNumber String
  ifsc          String

  // documents
  photo        String?
  aadhaarProof String?
  panProof     String?

  user User?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([department])
  @@index([designation])
  @@index([doj])
  @@index([mobile])
  @@index([createdAt])
  @@map("employees")
}

model Counter {
  id    String @id
  value Int
}
